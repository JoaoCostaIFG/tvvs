# Assignment 1 - G03P02

## Group information

- Ana Inês Oliveira de Barros - `up201806593@fe.up.pt`;
- João de Jesus Costa - `up201806560@fe.up.pt`

## Project description

The project is a time tracking tool that allows users to track their daily tasks
and the time invested in each of them. With this app, users obtain a record of
their activities and work time.

### Project structure

- The project is organized in 4 packages;
- The main function resides in the `JTimeSchedApp.java` file (in the root package);
- Most of the code logic resides in the `Project` class (in the project package).

```none
de.dominik_geyer.jtimesched            - root package
|-- JTimeSchedApp.java                 - location of main function
|-- gui                                - gui related code
|   |-- ColorDialog.java
|   |-- JTimeSchedFrame.java
|   |-- NotesDialog.java
|    -- table
|       |-- CheckCellRenderer.java
|       |-- ColorCellEditor.java
|       |-- ColorCellRenderer.java
|       |-- CustomCellRenderer.java      
|       |-- DateCellEditor.java
|       |-- ProjectTable.java
|       |-- TimeCellComponent.java
|       |-- TimeCellEditor.java
|        -- TimeCellRenderer.java
|-- misc
|    -- PlainTextFormatter.java
 -- project                            - task related code
    |-- Project.java                   - where most code logic resides
    |-- ProjectException.java
    |-- ProjectSerializer.java
    |-- ProjectTableModel.java
     -- ProjectTime.java
```

## Static testing

Static testing is one of the testing techniques for checking faults in software.
The main advantage of static code analysis is the fact that it is performed without
executing the code, thus being more lightweight than other types of testing. For
this reason, it is usually employed before executing the rest of the software's
test suite.

Static test tools are able to detect faults prior to the execution of other tests,
and warm about _suspicious_ aspects of the code. Another aspect that these tools
help with is code maintainability/design by allowing to enforce a certain code style.

## [Checkstyle tool](https://checkstyle.sourceforge.io/)

The Checkstyle tool makes it ideal for projects that want to enforce a coding standard. 
It can find class design problems, method design problems. It also has the ability to 
check code layout and formatting issues.

### Configuration

The Checkstyle plugin has a default rule set that indicates what issues the tool should 
look for. These rules are contained in `rulesets/checkstyle-rules.xml`. The rules were
adapted to reduce the amount irrelevant issues. These changes are listed below. 

1. Indentation

The default configuration considers indentation using tabs as a warning. Since we are
working with a fork of an open source project, we decided that the best option was to
conform to the indentation style of the author of the code.
Many lines of code were indented using tabs, so we adapted the rule set to accept this indentation.
Another issue was that _switch cases_ were not indented, so we had to set its indentation value to 0. 

Before:
```xml
<module name="Indentation">
      <property name="basicOffset" value="2"/>
      <property name="braceAdjustment" value="2"/>
      <property name="caseIndent" value="2"/>
      <property name="throwsIndent" value="4"/>
      <property name="lineWrappingIndentation" value="4"/>
      <property name="arrayInitIndent" value="2"/>
</module>
```

After:
```xml
 <module name="Indentation">
      <property name="basicOffset" value="8"/>
      <property name="braceAdjustment" value="8"/>
      <property name="caseIndent" value="0"/>
      <property name="throwsIndent" value="16"/>
      <property name="lineWrappingIndentation" value="16"/>
      <property name="arrayInitIndent" value="8"/>
 </module>
```

2. Underscore in package name

There were also a lot of warnings related to the package name. In the default 
configuration package names are checked against a specific REGEX which does not
allow the '_' character. Since we considered this error irrelevant, we changed
the rule to accept the `de.dominik_geyer.jtimesched` package name.

Before: `^[a-z]+(\.[a-z][a-z0-9]*)*$`
After: `^[a-z]+(\.[a-z][_a-z0-9]*)*$`

3. Import declaration groups

The tool was indicating that there was an issue regarding the groups of declaration of imports.
For example, an import from a `java` package shouldn't be separated from a `javax` import. Since
the author of the project organised the import declarations by grouping third party packages 
separately from the java standard ones, we adapted this rule to accept this separation.

Before: `<property name="customImportOrderRules" value="STATIC###THIRD_PARTY_PACKAGE"/>`

After: `<property name="customImportOrderRules" value="STATIC###STANDARD_JAVA_PACKAGE###THIRD_PARTY_PACKAGE"/>`

Since there is no information about the author's preference regarding the grouping of static imports
we left the default rule as it is (to separate the group of static import declarations).

4. If statement braces

Another irrelevant issues were caused by `if` statements missing braces. The ruleset was updated to 
ignore these by removing the *NeedBraces* rule.

``

### Bugs & Fixes

#### Method indentation level

**Warning:** *'method def lcurly' has incorrect indentation level 8, expected level should be 16.*

**Warning:** *'method def rcurly' has incorrect indentation level 8, expected level should be 16.*

**Location:** file `JTimeSchedApp.java`, lines 100, 389, and 401.

Before fix:
```java
     * @return String The application's version; if not set in Manifest or not available it returns the string "unknown"
     */
    public static String getAppVersion()
    {
        String appVersion = Package.getPackage("de.dominik_geyer.jtimesched").getImplementationVersion();
        return (appVersion != null) ? appVersion : "unknown";
```

After fix:
```java
     * @return String The application's version; if not set in Manifest or not available it returns the string "unknown"
     */
    public static String getAppVersion() {
        String appVersion = Package.getPackage("de.dominik_geyer.jtimesched").getImplementationVersion();
        return (appVersion != null) ? appVersion : "unknown";
```

#### Indentation tabs & spaces

**Warning:** *'method def' child has incorrect indentation level 8, expected level should be 16.*

**Location:** file `JTimeSchedFrame.java`, lines 136, 709, 712, 714, and 715.

Before fix:

`<TAB><SPC><SPC><SPC><SPC><TAB>JTimeSchedApp.getLogger().warning("Unable to create backup of project file: " + e.getMessage());`

After fix:

`<TAB><TAB><TAB>JTimeSchedApp.getLogger().warning("Unable to create backup of project file: " + e.getMessage());`

#### Brace location

**Warning:** *'{' at column 3 should be on the previous line.*

**Location:** file `ProjectSerializer.java` line 81.

Before fix:

```java
  for (Project p: projects)
        {
```

After fix:

```java
   for (Project p: projects) {
```

#### Indentation level in for loop

**Warning:** *'for' child has incorrect indentation level 18, expected level should be one of the following: 24, 32.*

**Location:** file `ProjectSerializer.java` lines 82, 84, 85, and 86.

Before fix:

```java
        for (Project p: projects) {
          startXmlElement(hd, "project", null);

          addXmlElement(hd, "title", null, p.getTitle());
          addXmlElement(hd, "notes", null, p.getNotes());
```

After fix:

```java
        for (Project p: projects) {
            startXmlElement(hd, "project", null);

            addXmlElement(hd, "title", null, p.getTitle());
            addXmlElement(hd, "notes", null, p.getNotes());
```

#### Method call indentation level 

**Warning:** *'.' has incorrect indentation level 40, expected level should be 48.*

**Location:** file `CustomCellRenderer.java` lines 71-76

Before fix:

```java
    if (!prj.getNotes().isEmpty()) {
        String tooltip = prj.getNotes()
            .replaceAll("&", "&amp;")
            .replaceAll("(\r\n|\n)", "<br/>")
            .replaceAll(" ", "&nbsp;")
            .replaceAll("\t", "&nbsp;&nbsp;&nbsp;&nbsp;");
```

After fix:

```java
    if (!prj.getNotes().isEmpty()) {
        String tooltip = prj.getNotes()
                .replaceAll("&", "&amp;")
                .replaceAll("(\r\n|\n)", "<br/>")
                .replaceAll(" ", "&nbsp;")
                .replaceAll("\t", "&nbsp;&nbsp;&nbsp;&nbsp;");
```

#### For loop indentation level 2

**Warning:** *'for' child has incorrect indentation level 18, expected level should be one of the following: 24, 32.*

**Location:** file `ProjectSerializer.java` lines 82, 84, 85, and 86.

Before fix:

```java
    for (Project p: projects) {
      startXmlElement(hd, "project", null);
      
      addXmlElement(hd, "title", null, p.getTitle());
      addXmlElement(hd, "notes", null, p.getNotes());
```

After fix:

```java
        for (Project p: projects) {
            startXmlElement(hd, "project", null);

            addXmlElement(hd, "title", null, p.getTitle());
            addXmlElement(hd, "notes", null, p.getNotes());
```

### Checkstyle Results

Number of issues reported by the Checkstyle tool:
- **Default Ruleset:** 4194
- **Before fixes (new ruleset/config):** 327
- **After fixes:** 263

## [Spotbugs](https://spotbugs.github.io/)

SpotBugs is a program which uses static analysis to look for bugs in Java code. 

### Configuration

Threshold was set to low since this is not a security critical application.

### Bugs & Fixes

#### Ignored return value

**Warning:** *Exceptional return value of java.io.File.mkdir() ignored in de.dominik_geyer.jtimesched.JTimeSchedApp.main(String[])*

**Location:** file `JTimeSchedApp.java` line 57.

Before fix:

```java
        File dirConf = new File(JTimeSchedApp.CONF_PATH);
        if (!dirConf.isDirectory())
            dirConf.mkdir();
```

After fix:

```java
        File dirConf = new File(JTimeSchedApp.CONF_PATH);
        if (!dirConf.isDirectory()) {
            if (!dirConf.mkdir()) {
                System.err.println("Unable to create configuration directory: " + JTimeSchedApp.CONF_PATH);
                System.exit(1);
            }
        }
```

#### Resource Fail

**Warning:** *de.dominik_geyer.jtimesched.gui.JTimeSchedFrame.backupProjects() may fail to clean up java.io.InputStream on checked exception*
**Location:** file `JTimeSchedFrame.java` line 709.

**Warning:** *de.dominik_geyer.jtimesched.gui.JTimeSchedFrame.backupProjects() may fail to clean up java.io.OutputStream on checked exception*
**Location:** file `JTimeSchedFrame.java` line 710.

Before fix:

```java
    FileInputStream fis = null;
        FileOutputStream fos = null;

        fis = new FileInputStream(file);
        fos = new FileOutputStream(new File(JTimeSchedApp.PRJ_FILE_BACKUP));

        byte[] buf = new byte[1024];
        int i = 0;
        while ((i = fis.read(buf)) != -1) {
        fos.write(buf, 0, i);
        }
        fis.close();
        fos.close();

```
After fix:

```java
        try (FileInputStream fis = new FileInputStream(file);
             FileOutputStream fos = new FileOutputStream(new File(JTimeSchedApp.PRJ_FILE_BACKUP))) {
            byte[] buf = new byte[1024];
            int i = 0;
            while ((i = fis.read(buf)) != -1) {
                fos.write(buf, 0, i);
            }
        }
```

**Important note:** Although this issue was fixed, the tool continues to report it as issue. 
As stated in the documentation, the heuristic used by the tool expects to find a _try/catch_ 
block followed by a _finally_ block. However, the recommended way to fix these types of 
errors is with a _try with resources_. Thus, we ignored further warnings about this bug
since it is considered a **false positive**.

#### Missing default branch

**Warning:** *inefficient new Integer(int) constructor; use Integer.valueOf(int) instead*

**Location:** file `ProjectSerializer.java` line 66.

**Important note:** This bug might seem like an easy fix. However, next to this line of code, there
is a commented [link](https://bugs.java.com/bugdatabase/view_bug.do?bug_id=6296446) that links to a
bug report. For this reason, we decided to leave this bug as it is since we are not sure of the 
consequences.

#### Inefficient boolean

**Warning:** *inefficient Boolean constructor; use Boolean.valueOf(...) instead*

**Location:** file `ProjectTableModel.java` lines 75 and 81.

Before fix:
```java
    case ProjectTableModel.COLUMN_CHECK:
        o = (prj.isChecked()) ? new Boolean(true) : new Boolean(false);
        break;
```

After fix:
```java
    case ProjectTableModel.COLUMN_CHECK:
        o = prj.isChecked()
        break;
```

#### Inefficient integer

**Warning:** *inefficient new Integer(int) constructor; use Integer.valueOf(int) instead*

**Location:** file `ProjectTableModel.java` lines 84 and 87.

Before fix:
```java
    case ProjectTableModel.COLUMN_TIMEOVERALL:
        o = new Integer(prj.getSecondsOverall());
        break;
```

After fix:
```java
    case ProjectTableModel.COLUMN_TIMEOVERALL:
        o = prj.getSecondsOverall();
        break;
```

#### Missing default case

**Warning:** *default case is missing*

**Location:** file `JTimeSchedFrame.java` line 971.

Before fix:
```java
    switch (keyCode) {
    case KeyEvent.VK_SPACE:
        handleStartPause(p);
        e.consume();
        break;
    case KeyEvent.VK_DELETE:
        handleDelete(ptm, p, row);
        e.consume();
        break;
    }
```

After fix:
```java
     switch (keyCode) {
    case KeyEvent.VK_SPACE:
        handleStartPause(p);
        e.consume();
        break;
    case KeyEvent.VK_DELETE:
        handleDelete(ptm, p, row);
        e.consume();
        break;
    default:
        // do nothing
        break;
    }
```

### Spotbugs Results

Number of issues reported by the Spotbugs tool:

**Before fixes:** 60
**After fixes:** 54